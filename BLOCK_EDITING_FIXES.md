# Исправления редактирования блоков

## Дата: 2 января 2026

## Проблемы, которые были исправлены:

### 1. Номер блока находился на большом удалении от блока

**Проблема:**
- При масштабировании (zoom) номера блоков "уезжали" далеко от самих блоков
- Использовалось фиксированное смещение в 20 пикселей, не учитывающее текущий zoom_factor

**Решение:**
- В файле `app/gui/page_viewer_blocks.py`:
  - Изменено позиционирование метки с `x2 - 20` на `x2 - 5/zoom_factor`
  - Теперь номер блока всегда находится в правом верхнем углу блока независимо от масштаба
  - Аналогично исправлено позиционирование галочки для блоков в группе

### 2. Невозможно было редактировать блок - он только перемещался

**Проблема:**
- При клике по блоку сразу начиналось перемещение (moving)
- Resize handles (маркеры изменения размера) появлялись только после выделения блока
- Пользователь не мог попасть в handles при первом клике, так как они еще не были видны

**Решение:**
- В файле `app/gui/page_viewer_mouse.py`:
  - Изменена логика обработки клика по блоку:
    - **Первый клик** по блоку просто выделяет его и показывает handles
    - **Второй клик** по уже выделенному блоку:
      - Если клик на handle → начинается изменение размера (resize)
      - Если клик мимо handles → начинается перемещение (move)
  
### 3. Увеличена область клика для handles

**Проблема:**
- Было сложно попасть мышью в маленькие handles

**Решение:**
- Увеличена область клика для:
  - Resize handles прямоугольных блоков: с 10 до 15 пикселей (с учетом zoom)
  - Vertex handles полигонов: с 10 до 15 пикселей (с учетом zoom)
  - Edge handles полигонов: с 8 до 12 пикселей (с учетом zoom)

## Затронутые файлы:

1. `app/gui/page_viewer_blocks.py` - позиционирование номеров блоков
2. `app/gui/page_viewer_mouse.py` - логика выделения и редактирования блоков
3. `app/gui/page_viewer_resize.py` - размер области клика для resize handles
4. `app/gui/page_viewer_polygon.py` - размер области клика для polygon handles

## Как теперь работает редактирование:

1. **Выделение блока**: Один клик по блоку → блок выделяется, появляются handles
2. **Изменение размера**: Клик на handle выделенного блока → изменение размера
3. **Перемещение**: Клик на тело выделенного блока (не на handle) → перемещение
4. **Множественное выделение**: Ctrl + клик или рамка выделения правой кнопкой

## Тестирование:

Необходимо протестировать:
- ✓ Создание новых блоков (прямоугольных и полигональных)
- ✓ Выделение существующих блоков
- ✓ Изменение размера блоков через handles
- ✓ Перемещение блоков
- ✓ Корректность позиционирования номеров блоков при разных zoom уровнях
- ✓ Множественное выделение блоков
