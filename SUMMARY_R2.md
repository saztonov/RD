# R2 Storage Integration - Ð ÐµÐ·ÑŽÐ¼Ðµ

## âœ… Ð§Ñ‚Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾

### 1. ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»

- **`app/r2_storage.py`** - Ð¼Ð¾Ð´ÑƒÐ»ÑŒ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Cloudflare R2
  - ÐšÐ»Ð°ÑÑ `R2Storage` Ñ S3-ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ñ‹Ð¼ API (boto3)
  - ÐœÐµÑ‚Ð¾Ð´Ñ‹: upload_file, upload_directory, upload_ocr_results
  - ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° presigned URLs, list/delete Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²

- **Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð² GUI**
  - `app/gui/ocr_manager.py` - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ OCR
  - `app/gui/ocr_dialog.py` - Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° R2 Ð² Ð´Ð¸Ð°Ð»Ð¾Ð³Ðµ

### 2. Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

- âœ… Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ R2Storage (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° credentials)
- âœ… ÐšÐ°Ð¶Ð´Ñ‹Ð¹ ÑÑ‚Ð°Ð¿ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²
- âœ… ÐžÑˆÐ¸Ð±ÐºÐ¸ Ñ ÐºÐ¾Ð´Ð°Ð¼Ð¸ Ð¸ Ð´ÐµÑ‚Ð°Ð»ÑÐ¼Ð¸ (ClientError)
- âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð°Ð¼Ð¸ Ñ„Ð°Ð¹Ð»Ð¾Ð²

### 3. Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸

- **`test_r2_upload.py`** - Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ R2
- **`CHECK_R2_LOGS.md`** - Ð±Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ð»Ð¾Ð³Ð°Ð¼
- **`docs/R2_TROUBLESHOOTING.md`** - Ð¿Ð¾Ð»Ð½Ð°Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°
- **`docs/R2_QUICK_START.md`** - Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð° 5 Ð¼Ð¸Ð½ÑƒÑ‚
- **`docs/R2_STORAGE_INTEGRATION.md`** - Ð¿Ð¾Ð»Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ

### 4. ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ

- **`.env.template`** - ÑˆÐ°Ð±Ð»Ð¾Ð½ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
- **`requirements.txt`** - Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ boto3>=1.28.0
- **`README.md`** - Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ñ€Ð°Ð·Ð´ÐµÐ»Ñ‹

## ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼

### Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ .env

```bash
# Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹:
R2_ACCOUNT_ID=...
R2_ACCESS_KEY_ID=...
R2_SECRET_ACCESS_KEY=...
R2_BUCKET_NAME=rd1
```

### Ð¨Ð°Ð³ 2: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ñ‚ÐµÑÑ‚

```bash
python test_r2_upload.py
```

### Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸

```
logs/app.log
```

Ð˜Ñ‰Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸:
- `=== Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ R2Storage ===`
- `R2_ACCOUNT_ID: âœ“` Ð¸Ð»Ð¸ `âœ— ÐÐ• Ð£ÐšÐÐ—ÐÐ`
- `âœ… R2Storage Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½` Ð¸Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
- `âœ… Ð¤Ð°Ð¹Ð» Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð² R2` Ð¸Ð»Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸

### Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ GUI

ÐŸÑ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ OCR (Ctrl+R) Ð² Ð´Ð¸Ð°Ð»Ð¾Ð³Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ:

```
R2 Bucket: âœ“ rd1 (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð² Ð¾Ð±Ð»Ð°ÐºÐ¾)
```

Ð•ÑÐ»Ð¸ Ð²Ð¸Ð´Ð¸Ñ‚Ðµ:
```
R2 Bucket: âœ— Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ)
```

â†’ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ `.env` Ñ„Ð°Ð¹Ð»

## ðŸ“‹ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð»Ð¾Ð³Ð¾Ð² R2

### Ð£ÑÐ¿ÐµÑˆÐ½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°

```
============================================================
=== OCRManager: Ð’Ñ‹Ð·Ð¾Ð² Ð¼ÐµÑ‚Ð¾Ð´Ð° _upload_to_r2 ===
Output directory: C:\...\output\project
Output directory exists: True
Project name: project
============================================================
=== Ð’Ð«Ð—ÐžÐ’ upload_ocr_to_r2() ===
output_dir: C:\...\output\project
project_name: project
Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€Ð° R2Storage...
============================================================
=== Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ R2Storage ===
R2_ACCOUNT_ID: âœ“
R2_ACCESS_KEY_ID: âœ“
R2_SECRET_ACCESS_KEY: âœ“
R2_BUCKET_NAME: rd1
R2_ENDPOINT_URL: https://abc123.r2.cloudflarestorage.com
âœ… R2Storage Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ (bucket: rd1, endpoint: https://...)
============================================================
=== Ð—ÐÐ“Ð Ð£Ð—ÐšÐ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ÐžÐ’ OCR Ð’ R2 ===
Output directory: C:\...\output\project
Project name: project
Remote prefix Ð² R2: ocr_results/project
Bucket: rd1
=== ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð² R2 ===
Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: C:\...\output\project
Remote prefix: ocr_results/project
Recursive: True
ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: 15
[1/15] Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°: document.pdf
ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°: C:\...\document.pdf â†’ rd1/ocr_results/project/document.pdf
Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°: 1234567 Ð±Ð°Ð¹Ñ‚
Content-Type: application/pdf
ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð² bucket 'rd1'...
âœ… Ð¤Ð°Ð¹Ð» Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð² R2: ocr_results/project/document.pdf (1234567 Ð±Ð°Ð¹Ñ‚)
[2/15] Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°: annotation.json
...
=== Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°: âœ… 15 ÑƒÑÐ¿ÐµÑˆÐ½Ð¾, âŒ 0 Ð¾ÑˆÐ¸Ð±Ð¾Ðº ===
âœ… Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð² R2 bucket 'rd1'
Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: âœ… SUCCESS
âœ… Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð² R2
```

### ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸

```
=== Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ R2Storage ===
R2_ACCOUNT_ID: âœ— ÐÐ• Ð£ÐšÐÐ—ÐÐ
R2_ACCESS_KEY_ID: âœ— ÐÐ• Ð£ÐšÐÐ—ÐÐ
R2_SECRET_ACCESS_KEY: âœ— ÐÐ• Ð£ÐšÐÐ—ÐÐ
âŒ ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ R2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ .env Ñ„Ð°Ð¹Ð»: ...
âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ R2 (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ .env Ñ„Ð°Ð¹Ð»): ...
```

### ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°

```
âŒ ClientError Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð² R2: AccessDenied - Access Denied
   Bucket: rd1, Key: ocr_results/project/document.pdf
```

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

1. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑˆÐ°Ð±Ð»Ð¾Ð½:
   ```bash
   copy .env.template .env
   ```

2. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ credentials Ð¸Ð· Cloudflare Dashboard

3. Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ `.env`

4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:
   ```bash
   python test_r2_upload.py
   ```

5. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ OCR â€” Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÑÑ‚ÑÑ Ð² R2

## ðŸ“– Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ

- **Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚:** [`docs/R2_QUICK_START.md`](docs/R2_QUICK_START.md)
- **Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°:** [`docs/R2_TROUBLESHOOTING.md`](docs/R2_TROUBLESHOOTING.md)
- **API Reference:** [`docs/R2_STORAGE_INTEGRATION.md`](docs/R2_STORAGE_INTEGRATION.md)
- **ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²:** [`CHECK_R2_LOGS.md`](CHECK_R2_LOGS.md)

## ðŸ”§ Ð¢Ð¸Ð¿Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹

| ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° | Ð ÐµÑˆÐµÐ½Ð¸Ðµ |
|----------|---------|
| R2 Bucket: âœ— Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ | Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ `.env` Ñ„Ð°Ð¹Ð» |
| InvalidAccessKeyId | ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ `R2_ACCESS_KEY_ID` |
| SignatureDoesNotMatch | ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ `R2_SECRET_ACCESS_KEY` |
| NoSuchBucket | Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ bucket `rd1` Ð² Dashboard |
| AccessDenied | Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ API Token Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ Read & Write |

---

**Ð’ÐµÑ€ÑÐ¸Ñ:** 1.0.0  
**Ð”Ð°Ñ‚Ð°:** 2025-12-02  
**Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ:** boto3>=1.28.0, python-dotenv>=1.0.0



