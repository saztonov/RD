# Применение исправлений

## Проблема
Задача OCR превышает таймаут и завершается с ошибкой `SoftTimeLimitExceeded()`.

## Исправления внесены в код

### 1. Увеличены таймауты Celery (services/remote_ocr/server/settings.py)
- `task_soft_timeout`: 1800 → **3000** (50 минут)
- `task_hard_timeout`: 2100 → **3600** (60 минут)

### 2. Уменьшен таймаут Datalab (rd_core/ocr/datalab.py)
- `MAX_POLL_ATTEMPTS`: 180 → **60** (3 минуты вместо 9)
- При таймауте возвращается пустая строка вместо ошибки (graceful degradation)

### 3. Добавлено логирование (services/remote_ocr/server/pdf_streaming_v2.py)
- Логирование начала/завершения обработки каждого strip/image блока

### 4. Исправлена ошибка парсинга annotation.json (rd_core/pdf_status.py)
- Поддержка двух форматов: `{"pages": [...]}` и `[...]`

### 5. Улучшена Remote OCR панель (app/gui/remote_ocr_panel.py)
- Автозапуск таймера обновления при загрузке
- Первое обновление сразу после старта
- Расширенное логирование создания задач

## Применение изменений

### Вариант 1: Перезапуск Docker (рекомендуется)

```bash
# В папке с docker-compose.yml
docker compose restart
```

### Вариант 2: Пересборка Docker

```bash
# Если изменения не применились после restart
docker compose down
docker compose build
docker compose up -d
```

### Проверка применения изменений

После перезапуска проверьте логи:

```bash
docker compose logs worker -f
```

Вы должны увидеть в логах новые сообщения:
- `PASS2: начало обработки strip ...`
- `PASS2: завершена обработка strip ...`
- `Datalab: пропускаем блок из-за таймаута, продолжаем обработку`

## Клиентское приложение

Перезапустите клиентское приложение Python для применения исправлений:

```bash
python -m app.main
```

## Проверка работы

1. Откройте документ в клиенте
2. Запустите распознавание (Send to OCR)
3. Задача должна сразу появиться в Remote OCR Jobs
4. При зависании Datalab на каком-то блоке - он будет пропущен через 3 минуты
5. Общий таймаут задачи увеличен до 50 минут

## Мониторинг

Следите за логами воркера:

```bash
docker compose logs worker --tail=100 -f
```

При успешной обработке вы увидите:
- Прогресс PASS1 (подготовка кропов)
- Прогресс PASS2 (OCR обработка)
- Завершение задачи: `Task run_ocr_task succeeded`
