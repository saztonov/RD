# Исправление краша при удалении штампов

## Проблема (из логов)

Программа крашилась после:
```
[StampRemover] Конвертация в QPixmap
```

Последнее действие перед крашем - конвертация PIL Image → QPixmap.

## Исправления

### 1. Глубокая копия QImage
```python
qimage = qimage.copy()  # Копируем данные до закрытия pdf_doc
```
**Причина:** данные QImage могли стать недействительными после выхода PIL Image из области видимости.

### 2. Указание stride для QImage
```python
QImage(data, width, height, width * 3, QImage.Format_RGB888)
```
**Причина:** явное указание шага строки (stride) для RGB формата.

### 3. Отложенная загрузка структуры
```python
def showEvent(self, event):
    # Загрузка структуры при первом показе диалога
```
**Причина:** избежать блокировки во время создания диалога.

### 4. Подробное логирование
Каждый шаг конвертации теперь логируется:
- Получение изображения
- Конвертация в RGB
- Создание QImage
- Создание QPixmap
- Масштабирование
- Установка в label

## Тест

```powershell
python -m app.main
```

1. Открыть большой PDF
2. Инструменты → Удалить штампы (Ctrl+D)
3. **Смотреть консоль** - теперь будут подробные логи:

```
[StampRemover] Изображение получено: (893, 1264)
[StampRemover] Конвертация в RGB
[StampRemover] Получение байтов изображения
[StampRemover] Создание QImage (893x1264)
[StampRemover] QImage создан, isNull=False
[StampRemover] Создание QPixmap
[StampRemover] QPixmap создан, размер: ...
[StampRemover] Масштабирование
[StampRemover] Масштабировано до: ...
[StampRemover] Установка pixmap в label
[StampRemover] Предпросмотр отображен успешно  <-- УСПЕХ
```

## Если все равно крашится

Лог покажет **точное место** краша между строками:
- Если между "Создание QImage" и "QImage создан" → проблема с QImage
- Если между "Установка pixmap" и "успешно" → проблема с Qt widget
- Если "QImage isNull=True" → проблема с данными изображения

## Возможные дополнительные причины

Если краш повторяется:

1. **Память** - слишком большие изображения
2. **Qt драйвер** - проблемы с графической подсистемой
3. **Threading** - event loop Qt заблокирован

## Отключить DEBUG логи

Если логов слишком много, в `app/main.py`:
```python
setup_logging(log_level=logging.INFO)
```

## Альтернативное решение

Если не помогает - отключить предпросмотр:
```python
def _show_preview_page(self, page_num: int):
    self.preview_label.setText(f"Предпросмотр отключен\nСтраница {page_num + 1}")
    return
```

