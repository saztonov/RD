# Интеграция Marker разметки с OCR

## Обзор

После разметки документа с помощью Marker, при запуске OCR каждый блок обрабатывается согласно его типу:

- **TEXT**: распознавание текста через Chandra/Qwen
- **TABLE**: распознавание таблиц через Chandra/Qwen  
- **IMAGE**: детальное описание на русском языке через Qwen VLM

## Workflow

### 1. Marker разметка

```
Инструменты → Marker разметка (Ctrl+M)
```

Marker автоматически определяет блоки и их типы (текст, таблица, изображение).

### 2. OCR обработка

```
Инструменты → Запустить OCR (Ctrl+R)
```

**Выберите режим:**
- ✅ **По блокам** - обрабатывает вашу Marker разметку
- ❌ Вся страница - игнорирует разметку

**Выберите движок:**
- **Локальный VLM сервер** - для всех типов блоков
- **Chandra OCR** - для TEXT/TABLE, VLM для IMAGE

### 3. Обработка по типам

#### TEXT и TABLE блоки
- Используется Chandra OCR или VLM
- Распознавание текста и таблиц в Markdown

#### IMAGE блоки
- Сохраняется кроп изображения в `temp_crops/`
- VLM создает детальное описание на русском:
  - Все видимые элементы
  - Текст на русском языке
  - Технические параметры, размеры
  - Схемы, диаграммы, структуры

### 4. Генерация Markdown

После OCR предлагается создать структурированный Markdown документ:

```markdown
# Страница 1

**Категория блока**

Распознанный текст...

**Изображение**

*Изображение:*

Детальное описание изображения на русском языке...

![Изображение](temp_crops/page0_block123.png)

---
```

## Технические детали

### Модифицированные файлы

#### `app/ocr.py`

**Новая функция:** `run_ocr_for_blocks()`
- Параметр `image_description_backend` для обработки IMAGE блоков
- Специальный промпт для детального описания изображений

**Новая функция:** `generate_structured_markdown()`
- Генерация markdown из размеченных блоков
- Вставка описаний и ссылок на кропы изображений
- Сортировка блоков по вертикальной позиции

#### `app/gui/main_window.py`

**Функция:** `_run_local_vlm_ocr_blocks()`
- Обработка IMAGE блоков с детальным описанием
- Сохранение кропов в `temp_crops/`

**Функция:** `_run_chandra_ocr_blocks()`
- TEXT/TABLE через Chandra
- IMAGE через VLM сервер

**Функция:** `_generate_structured_markdown()`
- Вызов генерации структурированного markdown

## Промпт для IMAGE блоков

```
Подробно опиши всё, что ты видишь на этом изображении.
Обрати внимание на все детали: текст, схемы, диаграммы, 
таблицы, графики, символы, цифры.
Если есть текст на русском языке - распознай и выведи его полностью.
Если есть техническая информация, параметры, размеры - укажи их точно.
Опиши структуру, компоненты, связи между элементами.
Ответ должен быть максимально информативным и на русском языке.
```

## Структура выходного файла

```
workspace/
├── recognized_document.md    # Структурированный markdown
└── temp_crops/               # Кропы изображений
    ├── page0_block123.png
    ├── page0_block456.png
    └── ...
```

## Требования

- Marker для разметки
- Chandra OCR (опционально) для TEXT/TABLE
- Локальный VLM сервер (Qwen3-VL) для IMAGE описаний
- VLM сервер на `http://127.0.0.1:1234/v1`

## Рекомендации

1. Сначала используйте **Marker** для качественной разметки
2. Проверьте типы блоков (IMAGE, TEXT, TABLE)
3. Запустите OCR **по блокам**
4. Сгенерируйте структурированный Markdown
5. Просмотрите результат с описаниями изображений

## Chandra документация

Подробнее о Chandra OCR: https://github.com/datalab-to/chandra

### Основные возможности

- Высокая точность на таблицах (88.0)
- Обработка форм (90.8)
- Рукописный текст (80.3)
- Полное сохранение layout

