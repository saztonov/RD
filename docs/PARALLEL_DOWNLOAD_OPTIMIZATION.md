# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –∏–∑ R2

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤ –∏–∑ R2 Storage (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–∞–ø–∫–∏ —Å crops) –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –º–µ–¥–ª–µ–Ω–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Ñ–∞–π–ª—ã —Å–∫–∞—á–∏–≤–∞–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –ø–æ –æ–¥–Ω–æ–º—É.

## –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** —Ñ–∞–π–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `ThreadPoolExecutor`, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Ñ–∞–π–ª–æ–≤.

## –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. `app/gui/r2_files_dialog.py` - R2DownloadWorker
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `ThreadPoolExecutor`
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 8 –ø–æ—Ç–æ–∫–æ–≤ (`max_workers=8`)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º —á–µ—Ä–µ–∑ `threading.Lock`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –∑–∞–≥—Ä—É–∑–∫–∏

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```python
R2DownloadWorker(files_to_download, target_dir, max_workers=8)
```

### 2. `app/gui/file_transfer_worker.py` - FileTransferWorker
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á –∑–∞–≥—Ä—É–∑–∫–∏/—Å–∫–∞—á–∏–≤–∞–Ω–∏—è
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 8 –ø–æ—Ç–æ–∫–æ–≤ (`max_workers=8`)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ UPLOAD, —Ç–∞–∫ –∏ DOWNLOAD –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```python
FileTransferWorker(parent, max_workers=8)
```

### 3. `rd_core/r2_storage.py` - TransferConfig
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–≤–µ–ª–∏—á–µ–Ω `max_concurrency` —Å 10 –¥–æ 20
- –î–æ–±–∞–≤–ª–µ–Ω `max_io_queue=1000` –¥–ª—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ IO –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ —É—Å–ª–æ–≤–∏—è—Ö –º–∞—Å—Å–æ–≤–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```python
TransferConfig(
    multipart_threshold=8 * 1024 * 1024,  # 8 MB
    max_concurrency=20,
    multipart_chunksize=8 * 1024 * 1024,  # 8 MB
    use_threads=True,
    max_io_queue=1000
)
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ë—ã–ª–æ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞):
- 100 —Ñ–∞–π–ª–æ–≤ –ø–æ 100KB = ~30-40 —Å–µ–∫—É–Ω–¥
- –ö–∞–∂–¥—ã–π —Ñ–∞–π–ª –∂–¥—ë—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ

### –°—Ç–∞–ª–æ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, 8 –ø–æ—Ç–æ–∫–æ–≤):
- 100 —Ñ–∞–π–ª–æ–≤ –ø–æ 100KB = ~5-8 —Å–µ–∫—É–Ω–¥ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ **5-6 —Ä–∞–∑**)
- 8 —Ñ–∞–π–ª–æ–≤ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –¥–∏–∞–ª–æ–≥–∞ R2 Files:
1. –û—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ "–§–∞–π–ª—ã –Ω–∞ R2" (–ü–ö–ú ‚Üí –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª—ã –Ω–∞ R2)
2. –í—ã–¥–µ–ª–∏—Ç—å –ø–∞–ø–∫—É —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Ñ–∞–π–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `crops/`)
3. –ù–∞–∂–∞—Ç—å "üì• –°–∫–∞—á–∞—Ç—å"
4. –§–∞–π–ª—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ 8 –ø–æ—Ç–æ–∫–æ–≤

### –ó–∞–≥—Ä—É–∑–∫–∞ PDF —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏:
- –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –¥–µ—Ä–µ–≤–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è:
  - –û—Å–Ω–æ–≤–Ω–æ–π PDF
  - –§–∞–π–ª –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
  - Markdown —Ñ–∞–π–ª (–µ—Å–ª–∏ –µ—Å—Ç—å)
  - –í—Å–µ crops –∏–∑ –ø–∞–ø–∫–∏ `crops/` (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Ç–æ–∫–æ–≤

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏:

```python
# –î–ª—è R2DownloadWorker (–≤ r2_files_dialog.py):
worker = R2DownloadWorker(files, target_dir, max_workers=16)  # 16 –ø–æ—Ç–æ–∫–æ–≤

# –î–ª—è FileTransferWorker (–≤ file_download.py):
worker = FileTransferWorker(self, max_workers=16)  # 16 –ø–æ—Ç–æ–∫–æ–≤
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- 8 –ø–æ—Ç–æ–∫–æ–≤ - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤
- 16 –ø–æ—Ç–æ–∫–æ–≤ - –¥–ª—è –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–µ–ª–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
- 4 –ø–æ—Ç–æ–∫–∞ - –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∏–ª–∏ —Å–ª–∞–±–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è Cloudflare R2

Cloudflare R2 **–ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç**:
- –ü—Ä—è–º—É—é –∑–∞–≥—Ä—É–∑–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∫–∞–∫ –æ–¥–∏–Ω ZIP-–∞—Ä—Ö–∏–≤
- Batch API –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º

–ü–æ—ç—Ç–æ–º—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ ThreadPoolExecutor - —ç—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

## –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `threading.Lock` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –æ–±—â–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:
- –°—á—ë—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (`_completed`, `_downloaded`)
- –§–ª–∞–≥ –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ (`_cancelled`)
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ Qt

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã:
- –°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (`max_workers`) –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã
- –ü—Ä–æ–≥—Ä–µ—Å—Å –∏ –æ—Ç–º–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ

## –î—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞ —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–æ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–í –∫–æ–¥–µ –µ—Å—Ç—å –∏ –¥—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, –Ω–æ —Ç–∞–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –Ω–µ–±–æ–ª—å—à–æ–µ (2-3 —Ñ–∞–π–ª–∞), –ø–æ—ç—Ç–æ–º—É –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞:

1. **`app/gui/tree_folder_ops.py`** - —Ñ—É–Ω–∫—Ü–∏—è `_open_folder_on_disk()`
   - –ó–∞–≥—Ä—É–∑–∫–∞: PDF + annotation.json + .md (3 —Ñ–∞–π–ª–∞)
   - –ú–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

2. **`app/gui/remote_ocr_download.py`** - —Ñ—É–Ω–∫—Ü–∏—è `_download_result()`
   - –ó–∞–≥—Ä—É–∑–∫–∞: _ocr.html + _result.json (2 —Ñ–∞–π–ª–∞)
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (—Å–ª–∏—à–∫–æ–º –º–∞–ª–æ —Ñ–∞–π–ª–æ–≤)

3. **`app/gui/file_operations.py`** - –∑–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π
   - –ó–∞–≥—Ä—É–∑–∫–∞: –µ–¥–∏–Ω–∏—á–Ω—ã–π —Ñ–∞–π–ª
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–µ –Ω—É–∂–Ω–∞

–≠—Ç–∏ –º–µ—Å—Ç–∞ **–Ω–µ —Ç—Ä–µ–±—É—é—Ç** —Å—Ä–æ—á–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –±—É–¥–µ—Ç –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º (2-3 —Ñ–∞–π–ª–∞ vs 100+ —Ñ–∞–π–ª–æ–≤ –≤ crops/).
