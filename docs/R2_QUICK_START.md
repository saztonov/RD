# R2 Storage - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ OCR –≤ Cloudflare R2 –∑–∞ 5 –º–∏–Ω—É—Ç.

## –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç–µ R2 credentials

1. –í–æ–π–¥–∏—Ç–µ –≤ [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **R2** ‚Üí **Overview**
3. –°–æ–∑–¥–∞–π—Ç–µ bucket `rd1`:
   - –ù–∞–∂–º–∏—Ç–µ **Create bucket**
   - –ò–º—è: `rd1`
   - Location hint: Automatic (–∏–ª–∏ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–≥–∏–æ–Ω)
   - –ù–∞–∂–º–∏—Ç–µ **Create bucket**

4. –°–æ–∑–¥–∞–π—Ç–µ API Token:
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **R2** ‚Üí **Manage R2 API Tokens**
   - –ù–∞–∂–º–∏—Ç–µ **Create API Token**
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ:
     - **Token name**: `RD-OCR-Upload`
     - **Permissions**: Object Read & Write
     - **Bucket**: `rd1` (–∏–ª–∏ All buckets)
     - **TTL**: –ù–µ —É–∫–∞–∑—ã–≤–∞—Ç—å (–±–µ—Å—Å—Ä–æ—á–Ω—ã–π)
   - –ù–∞–∂–º–∏—Ç–µ **Create API Token**

5. **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ credentials** (–æ–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!):
   ```
   Access Key ID: <—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ>
   Secret Access Key: <—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ>
   ```

6. –£–∑–Ω–∞–π—Ç–µ Account ID:
   - –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Overview —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É
   - –ò–ª–∏ –≤ URL: `dash.cloudflare.com/<ACCOUNT_ID>/r2/overview`

## –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ .env —Ñ–∞–π–ª

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —à–∞–±–ª–æ–Ω:
   ```bash
   copy .env.template .env
   ```

2. –û—Ç–∫—Ä–æ–π—Ç–µ `.env` –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ

3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ R2 —Å–µ–∫—Ü–∏—é:
   ```env
   # Cloudflare R2 Object Storage
   R2_ACCOUNT_ID=–≤–∞—à_account_id_–∑–¥–µ—Å—å
   R2_ACCESS_KEY_ID=–≤–∞—à_access_key_id_–∑–¥–µ—Å—å
   R2_SECRET_ACCESS_KEY=–≤–∞—à_secret_access_key_–∑–¥–µ—Å—å
   R2_BUCKET_NAME=rd1
   ```

4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª

## –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
   ```bash
   python app/main.py
   ```

2. –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±–æ–π PDF

3. –ù–∞–∂–º–∏—Ç–µ **–ó–∞–ø—É—Å—Ç–∏—Ç—å OCR** (Ctrl+R)

4. –í –¥–∏–∞–ª–æ–≥–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ OCR" –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   ```
   R2 Bucket: ‚úì rd1 (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ –æ–±–ª–∞–∫–æ)
   ```

   –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
   ```
   R2 Bucket: ‚úó –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (—Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
   ```
   
   ‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª (—à–∞–≥ 2)

## –®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ OCR

1. –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
2. –ù–∞–∂–º–∏—Ç–µ **OK**
3. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è OCR

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç:
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–ø–∫—É
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ R2 bucket `rd1`

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ R2

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Cloudflare Dashboard

1. –û—Ç–∫—Ä–æ–π—Ç–µ [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. **R2** ‚Üí **Overview** ‚Üí **rd1**
3. –ü–∞–ø–∫–∞ `ocr_results/<–∏–º—è_–ø—Ä–æ–µ–∫—Ç–∞>/`:
   - `document.pdf`
   - `annotation.json`
   - `document.md`
   - `crops/` (–ø–∞–ø–∫–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ

```python
from app.r2_storage import R2Storage

r2 = R2Storage()

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
files = r2.list_objects(prefix="ocr_results/my_project/")
for file in files:
    print(file)

# –í—Ä–µ–º–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ (1 —á–∞—Å)
url = r2.generate_presigned_url("ocr_results/my_project/document.pdf")
print(url)
```

## Troubleshooting

### "R2 Bucket: ‚úó –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

**–ü—Ä–∏—á–∏–Ω–∞:** .env —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã–π

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ 3 –∫–ª—é—á–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã:
   - `R2_ACCOUNT_ID`
   - `R2_ACCESS_KEY_ID`
   - `R2_SECRET_ACCESS_KEY`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

### "Access Denied" –≤ –ª–æ–≥–∞—Ö

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–µ credentials –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π –≤ `.env`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–æ–∫–µ–Ω –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ **Object Read & Write**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ bucket `rd1` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
4. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π API Token

### Bucket –Ω–µ –Ω–∞–π–¥–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–π–¥–∏—Ç–µ –≤ Cloudflare Dashboard
2. –°–æ–∑–¥–∞–π—Ç–µ bucket `rd1` (–∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ `R2_BUCKET_NAME` –≤ `.env`)

### –§–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `logs/app.log`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `boto3` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:
   ```bash
   pip install boto3
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ R2

```
rd1/
‚îî‚îÄ‚îÄ ocr_results/
    ‚îú‚îÄ‚îÄ –í–µ–Ω—Ç–∏–ª—è—Ü–∏—è/
    ‚îÇ   ‚îú‚îÄ‚îÄ 12.pdf
    ‚îÇ   ‚îú‚îÄ‚îÄ annotation.json
    ‚îÇ   ‚îú‚îÄ‚îÄ document.md
    ‚îÇ   ‚îî‚îÄ‚îÄ crops/
    ‚îÇ       ‚îú‚îÄ‚îÄ page0_block123.png
    ‚îÇ       ‚îî‚îÄ‚îÄ page0_block456.png
    ‚îú‚îÄ‚îÄ –≠–û–ú/
    ‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–∑–µ–º–ª–µ–Ω–∏–µ_part_002.pdf
    ‚îÇ   ‚îú‚îÄ‚îÄ annotation.json
    ‚îÇ   ‚îú‚îÄ‚îÄ document.md
    ‚îÇ   ‚îî‚îÄ‚îÄ crops/
    ‚îÇ       ‚îî‚îÄ‚îÄ page0_block789.png
    ‚îî‚îÄ‚îÄ ...
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–í–∞–∂–Ω–æ:**

- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` –≤ git
- –î–æ–±–∞–≤—å—Ç–µ –≤ `.gitignore`:
  ```
  .env
  .env.local
  .env.*.local
  ```
- –•—Ä–∞–Ω–∏—Ç–µ backup –∫–ª—é—á–µ–π –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ bucket-scoped tokens (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞)
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ API tokens

## –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

üìö [R2_STORAGE_INTEGRATION.md](R2_STORAGE_INTEGRATION.md)

---

**–í—Ä–µ–º—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:** ~5 –º–∏–Ω—É—Ç  
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:** Cloudflare –∞–∫–∫–∞—É–Ω—Ç (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç)





