# Настройка промптов OCR

## Обзор

Все промпты для OCR распознавания хранятся в папке `prompts/` в виде текстовых файлов. Это позволяет легко настраивать поведение OCR без изменения кода.

## Структура папки prompts/

```
prompts/
├── ocr_text.txt              # TEXT блоки
├── ocr_table.txt             # TABLE блоки
├── ocr_image_description.txt # IMAGE блоки
├── ocr_full_page.txt         # Полная страница
└── README.md                 # Документация
```

## Когда используется каждый промпт

### `ocr_text.txt`
**Используется для:** TEXT блоков при режиме "По блокам"

**Пример использования:**
- Обычный текст документа
- Абзацы, списки
- Заголовки и подзаголовки

**Дефолтный промпт:**
```
Распознай весь текст на этом изображении.
Сохрани структуру документа.
Выведи только распознанный текст без комментариев.
```

**Рекомендации по редактированию:**
- Укажите требования к структуре
- Определите формат вывода (Markdown, plain text)
- Уточните обработку списков, заголовков

### `ocr_table.txt`
**Используется для:** TABLE блоков при режиме "По блокам"

**Пример использования:**
- Таблицы с данными
- Технические характеристики
- Спецификации

**Дефолтный промпт:**
```
Распознай таблицу на этом изображении.
Преобразуй её в Markdown формат.
Сохрани точную структуру: строки, столбцы, заголовки.
Выведи только таблицу без дополнительных комментариев.
```

**Рекомендации по редактированию:**
- Выберите формат: Markdown, HTML, CSV
- Укажите обработку объединённых ячеек
- Определите поведение при пустых ячейках

### `ocr_image_description.txt`
**Используется для:** IMAGE блоков при режиме "По блокам"

**Пример использования:**
- Схемы и диаграммы
- Фотографии объектов
- Графики и чертежи

**Дефолтный промпт:**
```
Подробно опиши всё, что ты видишь на этом изображении.
Обрати внимание на все детали: текст, схемы, диаграммы, таблицы, графики, символы, цифры.
Если есть текст на русском языке - распознай и выведи его полностью.
Если есть техническая информация, параметры, размеры - укажи их точно.
Опиши структуру, компоненты, связи между элементами.
Ответ должен быть максимально информативным и на русском языке.
```

**Рекомендации по редактированию:**
- Определите уровень детализации
- Укажите язык ответа
- Уточните специфические элементы для поиска

### `ocr_full_page.txt`
**Используется для:** Режим "Вся страница" (автоматическая структура)

**Пример использования:**
- Распознавание всего документа
- Когда нет Marker разметки
- Быстрое распознавание без детальной разметки

**Дефолтный промпт:**
```
Распознай весь текст на этом изображении страницы документа.
Сохрани структуру документа: заголовки, абзацы, списки.
Если есть таблицы - представь их в Markdown формате.
Выведи только распознанный текст без комментариев.
```

## Как редактировать промпты

### Шаг 1: Откройте файл

Используйте любой текстовый редактор:
- Notepad++
- VSCode
- Sublime Text
- Блокнот Windows

```bash
# Windows
notepad prompts\ocr_image_description.txt

# Linux/Mac
nano prompts/ocr_image_description.txt
```

### Шаг 2: Измените текст

Пример - изменение языка описания на английский:

**Было:**
```
Ответ должен быть максимально информативным и на русском языке.
```

**Стало:**
```
Provide detailed description in English language.
```

### Шаг 3: Сохраните файл

Сохраните в кодировке **UTF-8**.

### Шаг 4: Перезапустите OCR

Промпты загружаются при каждом запуске OCR, поэтому:
- Не нужно перезапускать приложение
- Просто запустите OCR снова

## Примеры кастомизации

### Для технической документации

**`ocr_text.txt`:**
```
Распознай технический текст на изображении.
Сохрани все числовые параметры с единицами измерения.
Распознай формулы и обозначения.
Сохрани ссылки на стандарты (ГОСТ, СНиП и др.).
Формат вывода: plain text с сохранением структуры.
```

### Для архитектурных чертежей

**`ocr_image_description.txt`:**
```
Опиши архитектурный чертёж на изображении.
Укажи:
- Тип чертежа (план, фасад, разрез)
- Масштаб
- Размеры помещений
- Спецификацию элементов
- Условные обозначения
Ответ на русском языке.
```

### Для финансовых документов

**`ocr_table.txt`:**
```
Распознай финансовую таблицу.
Формат: Markdown таблица.
Особое внимание:
- Точность числовых значений
- Валюты и единицы
- Итоговые суммы
- Структура строк и столбцов
Проверь арифметику если есть суммы.
```

### Краткий режим (быстро)

**`ocr_text.txt`:**
```
Extract text.
```

**Плюсы:** Быстрее  
**Минусы:** Менее точно, меньше структуры

### Подробный режим (точно)

**`ocr_text.txt`:**
```
Выполни детальное OCR распознавание текста.
Сохрани всё форматирование:
- Заголовки разных уровней
- Нумерованные и ненумерованные списки
- Жирный и курсивный текст (если возможно определить)
- Абзацы с отступами
Распознай специальные символы: ©, ®, ™, °, ±
Исправь явные опечатки OCR.
Формат вывода: Markdown.
```

## Переменные (будущая функциональность)

В будущих версиях планируется поддержка переменных:

```
Распознай {block_type} блок.
Язык документа: {language}
Формат вывода: {output_format}
Страница {page_number} из {total_pages}
```

## Отладка промптов

### Проблема: OCR не работает

**Решение:**
1. Проверьте файл существует: `prompts/ocr_text.txt`
2. Проверьте кодировку: UTF-8
3. Проверьте права доступа на чтение

### Проблема: Результат не тот, что ожидается

**Решение:**
1. Упростите промпт
2. Уберите специальные символы
3. Протестируйте на простом примере
4. Добавляйте инструкции постепенно

### Проблема: VLM игнорирует промпт

**Решение:**
1. Некоторые модели лучше следуют инструкциям
2. Попробуйте более явные указания
3. Используйте примеры в промпте
4. Проверьте поддержку языка моделью

## Логирование

Для отладки включите подробное логирование в `app/main.py`:

```python
setup_logging(log_level=logging.DEBUG)
```

В логах будет:
```
DEBUG:app.ocr:Промпт загружен из ocr_text.txt
```

## API для промптов

### Python код

```python
from app.ocr import load_prompt

# Загрузить промпт
text_prompt = load_prompt("ocr_text.txt")

# Использовать в OCR
result = ocr_engine.recognize(image, prompt=text_prompt)
```

### Создание собственных промптов

Можно создать дополнительные файлы:

```bash
# Специальный промпт для схем
echo "Распознай электрическую схему..." > prompts/ocr_electrical_scheme.txt
```

Использование:
```python
custom_prompt = load_prompt("ocr_electrical_scheme.txt")
result = ocr_engine.recognize(image, prompt=custom_prompt)
```

## Best Practices

1. ✅ **Краткость** - чем короче промпт, тем быстрее
2. ✅ **Конкретность** - явные инструкции работают лучше
3. ✅ **Тестирование** - пробуйте на разных документах
4. ✅ **Версионирование** - сохраняйте старые версии промптов
5. ✅ **Документирование** - комментируйте зачем изменили

## Резервные копии

Перед большими изменениями:

```bash
# Windows
xcopy prompts prompts_backup\ /E /I

# Linux/Mac
cp -r prompts prompts_backup
```

## Ссылки

- [Главная документация](../README.md)
- [Marker OCR интеграция](MARKER_OCR_INTEGRATION.md)
- [Примеры промптов](../prompts/README.md)





