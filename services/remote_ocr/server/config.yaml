# =====================================================
# Конфигурация Remote OCR сервера
# =====================================================
# Приоритет: ENV переменные > значения из этого файла
# Секреты (API ключи, URL-ы) задаются ТОЛЬКО через .env
# Путь к конфигу можно переопределить через ENV OCR_CONFIG_PATH

# ===== CELERY WORKER =====
# Количество параллельных Celery задач
max_concurrent_jobs: 4
# Сколько задач брать заранее (1 = по одной)
worker_prefetch: 1
# Перезапуск воркера после N задач (защита от утечек памяти)
worker_max_tasks: 100
# Soft таймаут задачи, секунды (предупреждение)
task_soft_timeout: 3600
# Hard таймаут задачи, секунды (принудительное завершение)
task_hard_timeout: 4200
# Количество повторов при ошибке
task_max_retries: 3
# Задержка между повторами, секунды
task_retry_delay: 60

# ===== ЗАЩИТА ОТ ЗАЦИКЛИВАНИЯ =====
# Максимальное время выполнения одной задачи в часах
job_max_runtime_hours: 2
# Максимальное количество попыток (защита от бесконечного зацикливания)
job_max_retries: 3

# ===== OCR THREADING =====
# Глобальный лимит параллельных OCR запросов (все задачи)
max_global_ocr_requests: 8
# Потоков OCR внутри одной задачи
ocr_threads_per_job: 2
# Таймаут одного OCR запроса, секунды
ocr_request_timeout: 480

# ===== DATALAB API =====
# Максимум запросов в минуту к Datalab
datalab_max_rpm: 180
# Параллельных запросов к Datalab
datalab_max_concurrent: 5
# Интервал между проверками статуса задачи в Datalab, секунды
datalab_poll_interval: 3
# Максимум попыток проверки статуса (90 x 3сек = ~4.5 мин)
datalab_poll_max_attempts: 90
# Количество повторов при ошибке Datalab API
datalab_max_retries: 3

# ===== CHANDRA (LM Studio) =====
# Параллельных запросов к Chandra (LM Studio Max Concurrent Predictions >= этого значения)
chandra_max_concurrent: 2
# Пауза между retry при верификации блоков, секунды
chandra_retry_delay: 2

# ===== НАСТРОЙКИ OCR =====
# Сжатие PNG (0=без сжатия, 9=максимальное)
crop_png_compress: 6
# Максимум блоков в одном batch запросе
max_ocr_batch_size: 5
# DPI рендеринга PDF (влияет на качество и размер)
pdf_render_dpi: 300
# Максимальная высота полосы (strips), пиксели
max_strip_height: 9000

# ===== ДИНАМИЧЕСКИЙ ТАЙМАУТ =====
# Базовое время на инициализацию задачи, секунды
dynamic_timeout_base: 300
# Время на обработку одного блока, секунды
seconds_per_block: 30
# Минимальный таймаут задачи, секунды
min_task_timeout: 600
# Максимальный таймаут задачи, секунды
max_task_timeout: 14400

# ===== ОЧЕРЕДЬ =====
# Интервал проверки очереди, секунды
poll_interval: 10.0
# Максимальный интервал при backoff, секунды
poll_max_interval: 60.0
# Максимальный размер очереди Redis
max_queue_size: 100
# Приоритет задач по умолчанию (1=высший, 10=низший)
default_task_priority: 5

# ===== МОДЕЛИ OCR ПО УМОЛЧАНИЮ =====
# Движок по умолчанию: datalab | chandra | openrouter
default_engine: "datalab"
# Модель для распознавания изображений (OpenRouter)
default_image_model: "google/gemini-3-flash-preview"
# Модель для распознавания штампов (OpenRouter)
default_stamp_model: "xiaomi/mimo-v2-flash:free"
